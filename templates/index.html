<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress to Static Site Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .project-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .blur-bg {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 69, 19, 0.05));
            backdrop-filter: blur(20px);
        }
        .tab-button.active {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
            font-weight: 600;
        }
        .tab-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="min-h-screen blur-bg">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">
                        WordPress to Static Site Converter
                    </h1>
                    <p class="text-gray-600" id="header-subtitle">Verwalte deine statischen Website-Konvertierungen</p>
                </div>
                <div class="flex gap-3">
                    <button id="search-btn" class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg text-gray-700 py-2 px-4 rounded-lg hover:bg-opacity-30 transition duration-200 inline-flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Suchen
                    </button>
                    <a href="/preview" class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200 inline-flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        Preview
                    </a>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="flex justify-center mb-8">
                <div class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-lg p-1">
                    <button id="projects-tab" class="tab-button active px-6 py-2 rounded-md transition duration-200">
                        Meine Projekte
                    </button>
                    <button id="create-tab" class="tab-button px-6 py-2 rounded-md transition duration-200">
                        Neues Projekt
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div id="search-container" class="hidden mb-6">
                <div class="max-w-md mx-auto">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Projekte durchsuchen..."
                        class="w-full px-4 py-3 bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg border border-white border-opacity-30 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-500"
                    >
                </div>
            </div>

            <!-- Projects View -->
            <div id="projects-view">
                <!-- Filter Tabs -->
                <div class="flex justify-center mb-8">
                    <div class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-lg p-1">
                        <button id="all-tab" class="tab-button active px-6 py-2 rounded-md transition duration-200">
                            Alle Projekte
                        </button>
                        <button id="favorites-tab" class="tab-button px-6 py-2 rounded-md transition duration-200">
                            Favoriten
                        </button>
                    </div>
                </div>

                <!-- Projects Grid -->
                <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
                    <!-- Projects will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-16">
                    <div class="max-w-sm mx-auto">
                        <div class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Keine Projekte gefunden</h3>
                        <p class="text-gray-500 mb-6">Du hast noch keine WordPress-Projekte konvertiert.</p>
                        <button id="create-first-project" class="bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold inline-flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Erstes Projekt erstellen
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="text-center py-16">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="text-gray-600 mt-4">Projekte werden geladen...</p>
                </div>
            </div>

            <!-- Create Project View -->
            <div id="create-view" class="hidden">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white bg-opacity-95 backdrop-filter backdrop-blur-lg rounded-xl shadow-md p-8">
                        <div class="mb-6">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Neues Projekt erstellen</h2>
                            <p class="text-gray-600 mb-4">
                                Geben Sie die URL der WordPress-Website ein, die Sie als statische Kopie herunterladen m√∂chten.
                            </p>
                        </div>
                        
                        <form id="scraping-form" action="/start_scraping" method="POST" class="space-y-4">
                            <div>
                                <label for="url" class="block text-sm font-medium text-gray-700 mb-2">Website URL</label>
                                <input 
                                    type="url" 
                                    id="url" 
                                    name="url" 
                                    placeholder="https://beispiel-wordpress-site.com" 
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                            </div>
                            
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Projekt Name (optional)</label>
                                <input 
                                    type="text" 
                                    id="name" 
                                    name="name" 
                                    placeholder="Mein WordPress Projekt" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                                <p class="text-sm text-gray-500 mt-1">Wird automatisch aus der URL generiert, falls leer</p>
                            </div>
                            
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Beschreibung (optional)</label>
                                <textarea 
                                    id="description" 
                                    name="description" 
                                    rows="3"
                                    placeholder="Kurze Beschreibung des Projekts..."
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                ></textarea>
                            </div>
                            
                            <button 
                                type="submit" 
                                class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold"
                            >
                                Scraping starten
                            </button>
                        </form>
                        
                        <div class="mt-8 p-4 bg-blue-50 bg-opacity-50 backdrop-filter backdrop-blur-sm rounded-lg">
                            <h3 class="font-semibold text-blue-800 mb-2">Funktionen:</h3>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚úì Vollst√§ndige Website-Erfassung</li>
                                <li>‚úì Automatischer Asset-Download (Bilder, CSS, JS)</li>
                                <li>‚úì Link-Konvertierung f√ºr lokale Navigation</li>
                                <li>‚úì ZIP-Export der kompletten Site</li>
                                <li>‚úì Automatische Screenshot-Generierung</li>
                            </ul>
                        </div>
                        
                        <div class="mt-6 p-4 bg-yellow-50 bg-opacity-50 backdrop-filter backdrop-blur-sm rounded-lg">
                            <h3 class="font-semibold text-yellow-800 mb-2">Hinweise:</h3>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li>‚Ä¢ Der Scraping-Prozess kann je nach Website-Gr√∂√üe mehrere Minuten dauern</li>
                                <li>‚Ä¢ Nur √∂ffentlich zug√§ngliche Inhalte werden erfasst</li>
                                <li>‚Ä¢ Kontaktformulare werden deaktiviert</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Card Template -->
    <template id="project-card-template">
        <div class="project-card rounded-xl p-6 cursor-pointer">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1 min-w-0">
                    <h3 class="project-name text-lg font-semibold text-gray-800 truncate"></h3>
                    <p class="project-url text-sm text-gray-500 truncate"></p>
                </div>
                <button class="favorite-btn ml-3 p-1 rounded-full hover:bg-gray-100 transition duration-200">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                </button>
            </div>
            
            <div class="project-thumbnail mb-4 h-32 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg flex items-center justify-center overflow-hidden">
                <img class="thumbnail-img w-full h-full object-cover hidden" alt="Project thumbnail">
                <svg class="thumbnail-placeholder w-12 h-12 text-white opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
                </svg>
            </div>
            
            <div class="project-description text-sm text-gray-600 mb-4 h-12 overflow-hidden"></div>
            
            <div class="flex justify-between items-center text-xs text-gray-500 mb-4">
                <span class="project-pages">0 Seiten</span>
                <span class="project-size">0 MB</span>
            </div>
            
            <div class="project-status flex items-center justify-between">
                <span class="status-badge px-2 py-1 rounded-full text-xs font-medium"></span>
                <span class="project-date"></span>
            </div>
            
            <div class="flex gap-2 mt-4">
                <button class="view-btn flex-1 bg-blue-600 text-white py-2 px-3 rounded-lg hover:bg-blue-700 transition duration-200 text-sm font-medium">
                    Anzeigen
                </button>
                <button class="delete-btn p-2 text-red-500 hover:bg-red-50 rounded-lg transition duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    </template>

    <script>
        let allProjects = [];
        let currentFilter = 'all';
        let searchQuery = '';
        let currentView = 'projects'; // 'projects' or 'create'

        // Load projects on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            setupEventListeners();
        });

        function setupEventListeners() {
            // View toggle
            document.getElementById('projects-tab').addEventListener('click', () => switchView('projects'));
            document.getElementById('create-tab').addEventListener('click', () => switchView('create'));
            document.getElementById('create-first-project').addEventListener('click', () => switchView('create'));
            
            // Project filter tabs
            document.getElementById('all-tab').addEventListener('click', () => switchTab('all'));
            document.getElementById('favorites-tab').addEventListener('click', () => switchTab('favorites'));
            
            // Search functionality
            document.getElementById('search-btn').addEventListener('click', toggleSearch);
            document.getElementById('search-input').addEventListener('input', handleSearch);
            
            // Form submission
            document.getElementById('scraping-form').addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Starte Scraping...';
                submitBtn.classList.add('bg-gray-400');
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            });
        }

        function switchView(view) {
            currentView = view;
            
            // Update tab appearance
            document.querySelectorAll('#projects-tab, #create-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(view + '-tab').classList.add('active');
            
            // Show/hide views
            if (view === 'projects') {
                document.getElementById('projects-view').classList.remove('hidden');
                document.getElementById('create-view').classList.add('hidden');
                document.getElementById('header-subtitle').textContent = 'Verwalte deine statischen Website-Konvertierungen';
                document.getElementById('search-btn').style.display = 'flex';
            } else {
                document.getElementById('projects-view').classList.add('hidden');
                document.getElementById('create-view').classList.remove('hidden');
                document.getElementById('search-container').classList.add('hidden');
                document.getElementById('header-subtitle').textContent = 'Erstelle eine neue statische Website-Kopie';
                document.getElementById('search-btn').style.display = 'none';
            }
        }

        function switchTab(filter) {
            currentFilter = filter;
            
            // Update tab appearance
            document.querySelectorAll('#all-tab, #favorites-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(filter + '-tab').classList.add('active');
            
            // Filter projects
            filterProjects();
        }

        function toggleSearch() {
            const container = document.getElementById('search-container');
            const input = document.getElementById('search-input');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                input.focus();
            } else {
                container.classList.add('hidden');
                input.value = '';
                searchQuery = '';
                filterProjects();
            }
        }

        function handleSearch(e) {
            searchQuery = e.target.value.toLowerCase();
            filterProjects();
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                allProjects = await response.json();
                filterProjects();
            } catch (error) {
                console.error('Error loading projects:', error);
                showError('Fehler beim Laden der Projekte');
            }
        }

        function filterProjects() {
            let filteredProjects = allProjects;
            
            // Apply filter
            if (currentFilter === 'favorites') {
                filteredProjects = filteredProjects.filter(p => p.favorite);
            }
            
            // Apply search
            if (searchQuery) {
                filteredProjects = filteredProjects.filter(p => 
                    p.name.toLowerCase().includes(searchQuery) ||
                    p.url.toLowerCase().includes(searchQuery) ||
                    p.description.toLowerCase().includes(searchQuery)
                );
            }
            
            renderProjects(filteredProjects);
        }

        function renderProjects(projects) {
            const grid = document.getElementById('projects-grid');
            const emptyState = document.getElementById('empty-state');
            const loadingState = document.getElementById('loading-state');
            
            // Hide loading state
            loadingState.classList.add('hidden');
            
            if (projects.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            grid.innerHTML = '';
            
            projects.forEach(project => {
                const card = createProjectCard(project);
                grid.appendChild(card);
            });
        }

        function createProjectCard(project) {
            const template = document.getElementById('project-card-template');
            const card = template.content.cloneNode(true);
            
            // Populate card data
            card.querySelector('.project-name').textContent = project.name || 'Unbenanntes Projekt';
            card.querySelector('.project-url').textContent = project.url;
            card.querySelector('.project-description').textContent = project.description || 'Keine Beschreibung vorhanden';
            card.querySelector('.project-pages').textContent = `${project.total_pages} Seiten`;
            card.querySelector('.project-size').textContent = `${project.total_size_mb.toFixed(1)} MB`;
            
            // Status badge
            const statusBadge = card.querySelector('.status-badge');
            if (project.last_scraped_at) {
                statusBadge.textContent = 'Fertig';
                statusBadge.className = 'status-badge px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
            } else {
                statusBadge.textContent = 'Neu';
                statusBadge.className = 'status-badge px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800';
            }
            
            // Date
            const date = project.last_scraped_at || project.created_at;
            if (date) {
                const formattedDate = new Date(date).toLocaleDateString('de-DE');
                card.querySelector('.project-date').textContent = formattedDate;
            }
            
            // Thumbnail
            const thumbnailContainer = card.querySelector('.project-thumbnail');
            const thumbnailImg = card.querySelector('.thumbnail-img');
            const thumbnailPlaceholder = card.querySelector('.thumbnail-placeholder');
            
            if (project.thumbnail_path) {
                // Ensure proper path construction
                const imgPath = project.thumbnail_path.startsWith('/') ? project.thumbnail_path : '/' + project.thumbnail_path;
                thumbnailImg.src = imgPath;
                thumbnailImg.onload = function() {
                    thumbnailImg.classList.remove('hidden');
                    thumbnailPlaceholder.classList.add('hidden');
                };
                thumbnailImg.onerror = function() {
                    // Keep placeholder visible if image fails to load
                    console.log('Failed to load thumbnail:', project.thumbnail_path, 'at', imgPath);
                };
            }
            
            // Favorite button
            const favoriteBtn = card.querySelector('.favorite-btn');
            const heartIcon = favoriteBtn.querySelector('svg');
            if (project.favorite) {
                heartIcon.setAttribute('fill', 'currentColor');
                heartIcon.classList.add('text-red-500');
            }
            
            favoriteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(project.id);
            });
            
            // View button
            card.querySelector('.view-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                viewProject(project);
            });
            
            // Delete button
            card.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteProject(project.id);
            });
            
            return card;
        }

        async function toggleFavorite(projectId) {
            try {
                const project = allProjects.find(p => p.id === projectId);
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ favorite: !project.favorite })
                });
                
                if (response.ok) {
                    project.favorite = !project.favorite;
                    filterProjects();
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
            }
        }

        function viewProject(project) {
            if (project.last_scraped_at) {
                // Navigate to preview if scraped
                const domain = new URL(project.url).hostname.replace('www.', '');
                window.open(`/preview/${domain}`, '_blank');
            } else {
                // Start scraping if not scraped yet
                window.location.href = `/start_scraping?url=${encodeURIComponent(project.url)}`;
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('M√∂chten Sie dieses Projekt wirklich l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    allProjects = allProjects.filter(p => p.id !== projectId);
                    filterProjects();
                } else {
                    showError('Fehler beim L√∂schen des Projekts');
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                showError('Fehler beim L√∂schen des Projekts');
            }
        }

        function showError(message) {
            // Simple error display - could be enhanced with a toast system
            alert(message);
        }
    </script>
</body>
</html>